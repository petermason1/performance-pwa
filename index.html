<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Performance app with set lists, lyrics, Helix presets, and MIDI lighting control">
    <meta name="theme-color" content="#6366f1">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Performance App">
    
    <title>Performance PWA</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
</head>
<body>
    <div class="app-container">
        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab" data-view="performance">Performance</button>
            <button class="nav-tab" data-view="setlists">Set Lists</button>
            <button class="nav-tab" data-view="songs">Songs</button>
            <button class="nav-tab" data-view="lights">MIDI Lights</button>
        </nav>

        <!-- Performance View -->
        <div id="performance-view" class="view">
            <header>
                <h1>Performance</h1>
            </header>
            
            <div class="current-setlist-section">
                <select id="setlist-select" class="setlist-select">
                    <option value="">Select a Set List</option>
                </select>
                <button id="load-setlist-btn" class="btn btn-secondary">Load</button>
            </div>

            <div class="song-list-container" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h3 style="margin: 0;">Set List Songs</h3>
                    <button id="toggle-reorder-btn" class="btn btn-secondary btn-small">üîí Lock Order</button>
                </div>
                <div id="reorder-hint" style="display: none; background: var(--surface-light); padding: 10px; border-radius: 8px; margin-bottom: 10px; color: var(--text-secondary); font-size: 0.9rem;">
                    üí° Drag songs by the ‚ò∞ handle to reorder
                </div>
                <div class="song-list" id="current-songs-list">
                    <!-- Songs will be dynamically added here -->
                </div>
            </div>

            <div class="performance-controls">
                <div class="current-song-display">
                    <h2 id="current-song-name">--</h2>
                    <div class="bpm-display">
                        <span id="bpm-value">120</span>
                        <span class="bpm-label">BPM</span>
                        <span class="time-signature-display" id="time-signature-display">4/4</span>
                    </div>
                </div>

                <div class="tempo-wheel-container">
                    <div class="tempo-wheel" id="tempo-wheel">
                        <div class="wheel-background">
                            <div class="wheel-mark wheel-mark-1"></div>
                            <div class="wheel-mark wheel-mark-2"></div>
                            <div class="wheel-mark wheel-mark-3"></div>
                            <div class="wheel-mark wheel-mark-4"></div>
                        </div>
                        <div class="wheel-inner">
                            <div class="wheel-value" id="wheel-bpm-value">120</div>
                            <div class="wheel-label">BPM</div>
                        </div>
                        <div class="wheel-handle"></div>
                    </div>
                    <div class="tempo-wheel-controls">
                        <button id="tap-tempo-btn" class="btn btn-secondary">Tap Tempo</button>
                    </div>
                </div>

                <div class="lyrics-container">
                    <div class="lyrics-display" id="lyrics-display">
                        <p class="lyrics-placeholder">No song selected</p>
                    </div>
                </div>

                <div class="metronome-section">
                    <div class="visual-beat">
                        <div class="beat-indicator" id="beat-indicator"></div>
                    </div>
                    
                    <div class="controls">
                        <div class="control-group">
                            <label for="bpm-slider">Fine Tune Tempo</label>
                            <input type="range" id="bpm-slider" min="40" max="300" value="120" step="1">
                            <div class="range-labels">
                                <span>40</span>
                                <span>120</span>
                                <span>300</span>
                            </div>
                        </div>
                        
                        <div class="control-group">
                            <label for="time-signature-select">Time Signature</label>
                            <select id="time-signature-select">
                                <option value="2">2/4</option>
                                <option value="3">3/4</option>
                                <option value="4" selected>4/4 (Common Time)</option>
                                <option value="5">5/4</option>
                                <option value="6">6/8</option>
                                <option value="7">7/8</option>
                                <option value="9">9/8</option>
                                <option value="12">12/8</option>
                            </select>
                            <small>Beats per measure</small>
                        </div>
                        
                        <div class="control-group">
                            <label>Accent Pattern</label>
                            <div class="beat-pattern-selector" id="beat-pattern-selector">
                                <!-- Beat buttons will be generated dynamically -->
                            </div>
                            <div class="accent-controls">
                                <button type="button" id="clear-accents-btn" class="btn btn-secondary">Clear All</button>
                                <button type="button" id="no-accent-btn" class="btn btn-secondary">No Accent</button>
                            </div>
                            <small>Click beats to toggle accent on/off</small>
                        </div>
                        
                        <div class="control-group">
                            <label for="polyrhythm-select">Polyrhythm</label>
                            <select id="polyrhythm-select">
                                <option value="">None (Standard)</option>
                                <option value="3:2">3:2 (Three over Two)</option>
                                <option value="4:3">4:3 (Four over Three)</option>
                                <option value="5:4">5:4 (Five over Four)</option>
                                <option value="custom">Custom Pattern</option>
                            </select>
                            <small>Advanced rhythm patterns</small>
                        </div>
                        
                        <div class="control-group" id="custom-polyrhythm-group" style="display: none;">
                            <label for="custom-polyrhythm">Custom Pattern</label>
                            <input type="text" id="custom-polyrhythm" placeholder="e.g., 1,0,0,1,0,0" pattern="[01,]+">
                            <small>1 = accent, 0 = normal. Example: 1,0,0,1,0,0 creates a 3:2 pattern</small>
                        </div>
                        
                        <div class="button-group">
                            <button id="prev-song-btn" class="btn btn-secondary">‚óÄ Prev</button>
                            <button id="play-pause-btn" class="btn btn-primary">
                                <span id="play-icon">‚ñ∂</span>
                                <span id="pause-icon" style="display: none;">‚è∏</span>
                                <span id="btn-text">Start</span>
                            </button>
                            <button id="next-song-btn" class="btn btn-secondary">Next ‚ñ∂</button>
                        </div>
                        
                        <div id="save-changes-section" class="save-changes-section" style="display: none;">
                            <div class="unsaved-indicator">
                                <span class="unsaved-dot"></span>
                                <span>Settings changed</span>
                            </div>
                            <button id="save-song-btn" class="btn btn-primary save-btn">
                                <span id="save-icon">üíæ</span>
                                <span>Save Changes</span>
                            </button>
                            <button id="overwrite-song-btn" class="btn btn-secondary overwrite-btn" title="Hold to overwrite song">
                                <span>Hold to Overwrite</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="helix-info" id="helix-info">
                    <p>Helix Preset: <span id="helix-preset-name">--</span></p>
                    <p class="helix-status" id="helix-status">MIDI: Not connected</p>
                    <small id="helix-help" style="display: none;">
                        Connect via USB or 5-pin MIDI to your device, then select "Helix" in MIDI Lights tab.
                    </small>
                </div>
            </div>
        </div>

        <!-- Set Lists View -->
        <div id="setlists-view" class="view">
            <header>
                <h1>Set Lists</h1>
                <button id="new-setlist-btn" class="btn btn-primary">New Set List</button>
            </header>
            
            <div class="setlists-container" id="setlists-container">
                <!-- Set lists will be dynamically added here -->
            </div>
        </div>

        <!-- Set List Detail/Print View -->
        <div id="setlist-detail-view" class="view">
            <header>
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <h1 id="setlist-detail-name">Set List</h1>
                    <div style="display: flex; gap: 10px;">
                        <button id="print-setlist-btn" class="btn btn-primary">üñ®Ô∏è Print</button>
                        <button id="close-detail-btn" class="btn btn-secondary">Close</button>
                    </div>
                </div>
            </header>
            
            <div class="setlist-detail-info">
                <div class="setlist-summary">
                    <div class="summary-item">
                        <span class="summary-label">Total Songs:</span>
                        <span class="summary-value" id="detail-song-count">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Total Duration:</span>
                        <span class="summary-value" id="detail-total-duration">0:00</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Average BPM:</span>
                        <span class="summary-value" id="detail-avg-bpm">--</span>
                    </div>
                </div>
            </div>
            
            <div class="setlist-detail-songs" id="setlist-detail-songs">
                <!-- Songs will be listed here -->
            </div>
        </div>

        <!-- Songs View -->
        <div id="songs-view" class="view">
            <header>
                <h1>Songs</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <label for="song-sort-select" style="font-size: 0.9rem; color: var(--text-secondary);">Sort:</label>
                        <select id="song-sort-select" class="btn btn-secondary" style="padding: 8px 12px; font-size: 0.9rem;">
                            <option value="title">By Title</option>
                            <option value="artist" selected>By Artist</option>
                        </select>
                    </div>
                    <button id="new-song-btn" class="btn btn-primary">New Song</button>
                    <button id="import-songs-btn" class="btn btn-secondary">Import Songs</button>
                    <button id="export-data-btn" class="btn btn-secondary">Export Data</button>
                    <button id="import-data-btn" class="btn btn-secondary">Import Data</button>
                </div>
            </header>
            
            <div class="songs-container" id="songs-container">
                <!-- Songs will be dynamically added here -->
            </div>
        </div>

        <!-- MIDI Lights View -->
        <div id="lights-view" class="view">
            <header>
                <h1>MIDI Lights & Helix Control</h1>
            </header>
            
            <div class="helix-connection-info" style="background: var(--surface); padding: 20px; border-radius: 16px; margin-bottom: 20px;">
                <h3>üé∏ Helix & Audio Connection Guide</h3>
                <div style="margin-top: 15px;">
                    <div style="margin-bottom: 20px;">
                        <p style="font-weight: 600; margin-bottom: 10px;">üì± <strong>For iPad:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-secondary);">
                            <li><strong>USB MIDI:</strong> Use Lightning-to-USB adapter (or USB-C if iPad Pro) ‚Üí Connect Helix USB cable. Requires <strong>USB-Camera Adapter</strong> (not just charging adapter) for MIDI.</li>
                            <li><strong>Bluetooth MIDI:</strong> iPad supports Bluetooth MIDI! Enable in Settings ‚Üí Bluetooth, then pair Helix if it supports it.</li>
                            <li><strong>Audio for Click:</strong> Use USB audio interface (connected via adapter) OR route through mixing desk via audio cable (headphone jack to mixing desk).</li>
                            <li><strong>Alternative:</strong> Use a USB audio interface that does both MIDI and audio (like Focusrite Scarlett, PreSonus, etc.)</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p style="font-weight: 600; margin-bottom: 10px;">üî• <strong>For Amazon Fire Tablet:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-secondary);">
                            <li><strong>USB MIDI:</strong> Use USB-C to USB-A adapter ‚Üí Connect Helix USB cable. May need USB OTG adapter.</li>
                            <li><strong>Bluetooth MIDI:</strong> Fire tablets may support Bluetooth MIDI (varies by model). Check Settings.</li>
                            <li><strong>Audio for Click:</strong> Use USB audio interface OR connect headphone jack to mixing desk (3.5mm to 1/4" or XLR adapter).</li>
                            <li><strong>Note:</strong> Some Fire tablets have limited audio/MIDI support. Test MIDI in browser first.</li>
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p style="font-weight: 600; margin-bottom: 10px;">üíª <strong>For Desktop/Laptop:</strong></p>
                        <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-secondary);">
                            <li><strong>USB MIDI:</strong> Connect Helix directly via USB cable.</li>
                            <li><strong>5-Pin MIDI:</strong> Use MIDI interface connected via USB/Thunderbolt.</li>
                            <li><strong>Audio:</strong> Route audio output (headphone jack, audio interface) to mixing desk.</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--surface-light); padding: 15px; border-radius: 8px; margin-top: 20px;">
                        <p style="margin: 0 0 10px 0;"><strong>üéß Audio Routing (Metronome Click):</strong></p>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                            The metronome click is <strong>audio</strong>, not MIDI or Bluetooth. Options:
                        </p>
                        <ul style="margin: 10px 0 0 0; padding-left: 20px; color: var(--text-secondary); font-size: 0.9rem;">
                            <li><strong>USB Audio Interface:</strong> Best quality, low latency (Focusrite, PreSonus, etc.)</li>
                            <li><strong>Headphone Jack:</strong> Connect 3.5mm ‚Üí 1/4" or XLR adapter ‚Üí Mixing desk</li>
                            <li><strong>Bluetooth Audio:</strong> Can work but may have latency (pair tablet to mixing desk/audio interface if supported)</li>
                        </ul>
                    </div>
                    
                    <div style="background: var(--accent); padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <p style="margin: 0; font-size: 0.9rem;"><strong>üí° Pro Tip:</strong> Use a USB audio interface that supports both MIDI and audio (like Focusrite Scarlett 2i2, PreSonus AudioBox, etc.). Connect Helix via USB to interface, then interface to tablet. This gives you both MIDI control AND clean audio output!</p>
                    </div>
                </div>
            </div>
            
            <div class="midi-controls">
                <div class="control-group">
                    <label for="midi-output-select">MIDI Output Device</label>
                    <select id="midi-output-select">
                        <option value="">No device selected</option>
                    </select>
                    <button id="refresh-midi-btn" class="btn btn-secondary">Refresh Devices</button>
                </div>

                <div class="light-programming">
                    <h3>Light Programming</h3>
                    <div class="light-timeline" id="light-timeline">
                        <!-- Light events will be added here -->
                    </div>
                    <div class="light-controls">
                        <button id="add-light-event-btn" class="btn btn-secondary">Add Light Event</button>
                        <button id="test-lights-btn" class="btn btn-secondary">Test Lights</button>
                    </div>
                </div>

                <div class="midi-notes">
                    <h3>MIDI Notes Reference</h3>
                    <div class="note-grid" id="note-grid">
                        <!-- MIDI note buttons will be generated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div id="song-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 id="song-modal-title">New Song</h2>
                <form id="song-form">
                    <input type="hidden" id="song-id">
                    
                    <div class="form-group">
                        <label for="song-name">Song Name</label>
                        <input type="text" id="song-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="song-bpm">BPM</label>
                        <input type="number" id="song-bpm" min="40" max="300" value="120" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="song-duration">Duration (minutes)</label>
                        <input type="number" id="song-duration" min="0" max="60" step="0.1" placeholder="e.g., 3.5">
                        <small>Leave empty to calculate from lyrics timestamps</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="song-time-signature">Time Signature</label>
                        <select id="song-time-signature">
                            <option value="4">4/4</option>
                            <option value="3">3/4</option>
                            <option value="2">2/4</option>
                            <option value="6">6/8</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="song-helix-preset">Helix Preset Name</label>
                        <input type="text" id="song-helix-preset" placeholder="e.g., Clean Chorus">
                    </div>
                    
                    <div class="form-group">
                        <label for="song-helix-preset-number">Helix Preset Number (0-127)</label>
                        <input type="number" id="song-helix-preset-number" min="0" max="127" placeholder="Auto-send preset change via MIDI">
                        <small>Program number to send when song loads (via MIDI). Leave empty to disable auto-switching.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="song-lyrics">Lyrics (with timestamps)</label>
                        <textarea id="song-lyrics" rows="10" placeholder="Format: [00:00.00] Line 1&#10;[00:04.00] Line 2&#10;[00:08.00] Line 3"></textarea>
                        <small>Format: [MM:SS.mm] Your lyrics here</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="song-midi-notes">MIDI Light Notes (comma-separated)</label>
                        <input type="text" id="song-midi-notes" placeholder="e.g., 36,40,44">
                        <small>MIDI note numbers for lighting cues</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="import-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Import Songs</h2>
                <p style="margin-bottom: 15px; color: var(--text-secondary);">Paste your song list below. Each line should contain: Song Name, BPM, and optionally Key/Notes.</p>
                <form id="import-form">
                    <div class="form-group">
                        <label for="import-data">Song Data</label>
                        <textarea id="import-data" rows="15" placeholder="Arctic Monkeys - Bet You Look Good on the Dance Floor	204&#10;Arctic Monkeys - Mardy Bum	112&#10;Blink 182 - All The Small Things	152"></textarea>
                        <small>Format: Song Title (tab or space) BPM (tab or space) Key/Notes (optional)</small>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Import</button>
                        <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Export/Import Data Modal -->
        <div id="data-export-modal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close">&times;</span>
                <h2>Export/Import All Data</h2>
                
                <!-- Export Section -->
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">üì§ Export All Data</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Copy all your songs and set lists to transfer to another device (phone, tablet, etc.)
                    </p>
                    <textarea id="export-data-textarea" readonly style="width: 100%; min-height: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 0.85rem; background: var(--surface-light);"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button id="copy-export-btn" class="btn btn-primary">üìã Copy to Clipboard</button>
                        <button id="download-export-btn" class="btn btn-secondary">üíæ Download as File</button>
                    </div>
                </div>
                
                <hr style="border: none; border-top: 1px solid var(--border); margin: 30px 0;">
                
                <!-- Import Section -->
                <div>
                    <h3 style="margin-bottom: 15px;">üì• Import Data</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Paste exported data here to add to this device. Choose "Replace" to wipe existing data, or "Merge" to add new items.
                    </p>
                    <textarea id="import-data-textarea" placeholder="Paste exported data here..." style="width: 100%; min-height: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 0.85rem;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                        <button id="import-data-replace-btn" class="btn btn-danger">‚ö†Ô∏è Replace All Data</button>
                        <button id="import-data-merge-btn" class="btn btn-primary">‚ûï Merge Data</button>
                        <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: var(--surface-light); border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                        <strong>Replace:</strong> Removes all current data and imports new data.<br>
                        <strong>Merge:</strong> Adds new songs/set lists without deleting existing ones. Duplicates (by name) are skipped.
                    </div>
                </div>
            </div>
        </div>

        <div id="setlist-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 id="setlist-modal-title">New Set List</h2>
                <form id="setlist-form">
                    <input type="hidden" id="setlist-id">
                    
                    <div class="form-group">
                        <label for="setlist-name">Set List Name</label>
                        <input type="text" id="setlist-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="setlist-songs">Songs</label>
                        <div class="setlist-controls-bar">
                            <button type="button" id="sort-alphabetical-btn" class="btn btn-secondary btn-small">Sort A-Z</button>
                            <span id="song-count-display" class="song-count">0 songs</span>
                        </div>
                        <div id="available-songs-list" class="song-checkbox-list sortable-song-list">
                            <!-- Available songs will be added here -->
                        </div>
                        <div style="background: var(--surface-light); padding: 10px; border-radius: 8px; margin-top: 10px;">
                            <small style="color: var(--primary-color); font-weight: 600;">üí° How to reorder:</small>
                            <ul style="margin: 5px 0 0 20px; padding: 0; color: var(--text-secondary); font-size: 0.85rem;">
                                <li>Click ‚ò∞ handle on the left of a song</li>
                                <li>Drag it up or down to reorder</li>
                                <li>Selected songs show numbers (1, 2, 3...)</li>
                                <li>Click checkbox to add/remove from set list</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <footer>
            <p class="install-prompt" id="install-prompt" style="display: none;">
                Install this app for offline access
            </p>
        </footer>
    </div>
    
    <script src="models.js"></script>
    <script src="metronome.js"></script>
    <script src="midi.js"></script>
    <script src="import-songs.js"></script>
    <script src="app.js"></script>
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }
    </script>
</body>
</html>
